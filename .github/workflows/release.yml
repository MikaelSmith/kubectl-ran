name: Release kubectl-ran

on:
  release:
    types: [created]

jobs:
  build-deploy:
    name: Build and upload release assets
    runs-on: ubuntu-latest
    steps:
    - name: Set up Go
      uses: actions/setup-go@v1
      with:
        go-version: 1.17
      id: go
    - name: Check out code
      uses: actions/checkout@v2
    - name: Get dependencies
      run: go get -v -t -d ./...
    - name: Build
      run: |
        tag=${GITHUB_REF#refs/tags/}
        LINKFLAGS="-w -s"
        CGO_ENABLED= GOOS=darwin GOARCH=amd64 go build -ldflags="$LINKFLAGS"
        tar czf kubectl-ran-${tag}-x86_64-apple-darwin.tgz kubectl-ran
        cp kubectl-ran-${tag}-x86_64-apple-darwin.tgz kubectl-ran-x86_64-apple-darwin.tgz
        CGO_ENABLED= GOOS=linux GOARCH=amd64 go build -ldflags="$LINKFLAGS"
        tar czf kubectl-ran-${tag}-x86_64-unknown-linux.tgz kubectl-ran
        cp kubectl-ran-${tag}-x86_64-unknown-linux.tgz kubectl-ran-x86_64-unknown-linux.tgz
    - name: Upload release assets
      uses: skx/github-action-publish-binaries@release-2.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        args: 'kubectl-ran-*.tgz'
